---
  - name: Install munin-node
    apt: pkg={{item}} state=installed update_cache=true
    with_items:
      - munin-node
      - munin-plugins-core
      - munin-plugins-extra
    register: muninnodeinstalled
    # if there's no Apache, there's nothing to monitor
    when: apache2installed|success
    notify:
     - Start munin-node

  - name: Create Apache vhost
    when: muninnodeinstalled|success
    template: src=munin-stats dest=/etc/apache2/sites-available/munin-stats mode=775 owner=root group=root
    register: apachemuninvhostcreated
    notify:
      - Restart munin-node

  - name: Create munin node config
    when: muninnodeinstalled|success
    template: src=munin-node dest=/etc/munin/plugin-conf.d/munin-node mode=775 owner=root group=root
    notify:
      - Restart munin-node

  - name: Enable Apache vhost
    when: apachemuninvhostcreated|success
    file: src=/etc/apache2/sites-available/munin-stats dest=/etc/apache2/sites-enabled/munin-stats mode=775 owner=root group=root state=link
    notify:
      - Reload Apache
